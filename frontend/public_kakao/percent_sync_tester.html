<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>가중치 동기화 테스트</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 800px;
            width: 100%;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }
        
        .header p {
            color: #666;
            font-size: 16px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
        }
        
        .test-section h3 {
            color: #334155;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .weight-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .weight-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .weight-item label {
            font-weight: 500;
            color: #475569;
            font-size: 14px;
        }
        
        .weight-input {
            padding: 8px 12px;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .weight-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .total-display {
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
            font-weight: 600;
        }
        
        .total-display.valid {
            background: #dcfce7;
            border-color: #10b981;
            color: #065f46;
        }
        
        .total-display.invalid {
            background: #fee2e2;
            border-color: #ef4444;
            color: #991b1b;
        }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .status-display {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .instructions {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
        }
        
        .instructions h3 {
            margin-bottom: 10px;
        }
        
        .instructions ol {
            margin-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .loading {
            animation: pulse 1.5s infinite;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🎯 가중치 동기화 테스트 도구</h1>
            <p>percent.js 시스템의 실시간 데이터 동기화를 테스트합니다</p>
        </div>
        
        <div class="instructions">
            <h3>📋 테스트 방법</h3>
            <ol>
                <li>아래 가중치 값들을 조정하여 <strong>총합 100%</strong>를 만드세요</li>
                <li><strong>"가중치 적용 및 동기화"</strong> 버튼을 클릭하세요</li>
                <li>다른 탭들(mainpage.html, rank_member.html, rank_party.html)을 열어서 실시간 업데이트를 확인하세요</li>
                <li>상태 로그에서 동기화 과정을 모니터링하세요</li>
            </ol>
        </div>
        
        <div class="test-section">
            <h3>⚖️ 가중치 설정</h3>
            <div class="weight-grid">
                <div class="weight-item">
                    <label>간사</label>
                    <input type="number" class="weight-input" data-weight="간사" value="3" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>무효표 및 기권</label>
                    <input type="number" class="weight-input" data-weight="무효표 및 기권" value="2" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>본회의 가결</label>
                    <input type="number" class="weight-input" data-weight="본회의 가결" value="40" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>위원장</label>
                    <input type="number" class="weight-input" data-weight="위원장" value="5" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>청원 소개</label>
                    <input type="number" class="weight-input" data-weight="청원 소개" value="8" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>청원 결과</label>
                    <input type="number" class="weight-input" data-weight="청원 결과" value="23" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>출석</label>
                    <input type="number" class="weight-input" data-weight="출석" value="8" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>투표 결과 일치</label>
                    <input type="number" class="weight-input" data-weight="투표 결과 일치" value="7" min="0" max="100">
                </div>
                <div class="weight-item">
                    <label>투표 결과 불일치</label>
                    <input type="number" class="weight-input" data-weight="투표 결과 불일치" value="4" min="0" max="100">
                </div>
            </div>
            
            <div class="total-display" id="totalDisplay">
                총합: <span id="totalValue">100</span>% 
                <span id="totalStatus">✅ 100% 달성!</span>
            </div>
        </div>
        
        <div class="test-section">
            <h3>🚀 동기화 테스트</h3>
            <button class="btn btn-success" onclick="applyWeightsAndSync()">
                🎯 가중치 적용 및 동기화
            </button>
            <button class="btn btn-primary" onclick="checkConnectionStatus()">
                🔍 연결 상태 확인
            </button>
            <button class="btn btn-warning" onclick="testBroadcast()">
                📡 브로드캐스트 테스트
            </button>
            <button class="btn btn-danger" onclick="resetToOriginal()">
                🔄 원본 데이터로 리셋
            </button>
        </div>
        
        <div class="test-section">
            <h3>📊 상태 모니터링</h3>
            <div class="status-display" id="statusLog">
                📱 동기화 테스트 도구 준비 완료
                
                🔗 다음 페이지들이 열려있어야 합니다:
                - mainpage.html (메인 페이지)
                - rank_member.html (의원 랭킹)
                - rank_party.html (정당 랭킹)
                - percent.html (가중치 설정)
                
                💡 팁: 각 페이지를 새 탭으로 열어두고 테스트하세요!
            </div>
        </div>
    </div>

    <script>
        // 가중치 계산 및 UI 업데이트
        function updateTotal() {
            const inputs = document.querySelectorAll('.weight-input');
            let total = 0;
            
            inputs.forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            
            const totalValue = document.getElementById('totalValue');
            const totalStatus = document.getElementById('totalStatus');
            const totalDisplay = document.getElementById('totalDisplay');
            
            totalValue.textContent = total.toFixed(1);
            
            if (Math.abs(total - 100) < 0.1) {
                totalDisplay.className = 'total-display valid';
                totalStatus.textContent = '✅ 100% 달성!';
            } else {
                totalDisplay.className = 'total-display invalid';
                totalStatus.textContent = `⚠️ ${total > 100 ? '초과' : '부족'} (${(100 - total).toFixed(1)}% ${total > 100 ? '감소' : '추가'} 필요)`;
            }
        }
        
        // 가중치 입력 이벤트 리스너
        document.querySelectorAll('.weight-input').forEach(input => {
            input.addEventListener('input', updateTotal);
        });
        
        // 로그 추가 함수
        function addLog(message, type = 'info') {
            const statusLog = document.getElementById('statusLog');
            const timestamp = new Date().toLocaleTimeString();
            const icon = type === 'success' ? '✅' : type === 'error' ? '❌' : type === 'warning' ? '⚠️' : '📡';
            
            statusLog.textContent += `\n[${timestamp}] ${icon} ${message}`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }
        
        // 가중치 적용 및 동기화
        async function applyWeightsAndSync() {
            const inputs = document.querySelectorAll('.weight-input');
            let total = 0;
            const weights = {};
            
            inputs.forEach(input => {
                const value = parseFloat(input.value) || 0;
                weights[input.dataset.weight] = value;
                total += value;
            });
            
            if (Math.abs(total - 100) > 0.1) {
                addLog(`가중치 총합이 100%가 아닙니다 (현재: ${total.toFixed(1)}%)`, 'error');
                return;
            }
            
            addLog('가중치 적용 및 동기화 시작...', 'info');
            
            try {
                // 테스트 데이터 생성
                const testData = {
                    type: 'calculated_data_distribution',
                    source: 'sync_tester',
                    timestamp: new Date().toISOString(),
                    appliedWeights: weights,
                    
                    // 모의 정당 데이터
                    partyData: {
                        total: 8,
                        top3: [
                            { rank: 1, name: '더불어민주당', score: 87.5, original_score: 78.1, score_changed: true, weight_applied: true },
                            { rank: 2, name: '진보당', score: 85.2, original_score: 75.8, score_changed: true, weight_applied: true },
                            { rank: 3, name: '조국혁신당', score: 82.9, original_score: 72.3, score_changed: true, weight_applied: true }
                        ],
                        full_list: [
                            { rank: 1, name: '더불어민주당', calculated_score: 87.5, original_score: 78.1, score_changed: true, weight_applied: true },
                            { rank: 2, name: '진보당', calculated_score: 85.2, original_score: 75.8, score_changed: true, weight_applied: true },
                            { rank: 3, name: '조국혁신당', calculated_score: 82.9, original_score: 72.3, score_changed: true, weight_applied: true },
                            { rank: 4, name: '국민의힘', calculated_score: 79.8, original_score: 69.5, score_changed: true, weight_applied: true },
                            { rank: 5, name: '개혁신당', calculated_score: 76.4, original_score: 67.2, score_changed: true, weight_applied: true },
                            { rank: 6, name: '기본소득당', calculated_score: 73.1, original_score: 65.8, score_changed: true, weight_applied: true },
                            { rank: 7, name: '사회민주당', calculated_score: 70.5, original_score: 63.4, score_changed: true, weight_applied: true },
                            { rank: 8, name: '무소속', calculated_score: 68.2, original_score: 61.1, score_changed: true, weight_applied: true }
                        ]
                    },
                    
                    // 모의 의원 데이터  
                    memberData: {
                        total: 300,
                        top3: [
                            { rank: 1, name: '어기구', party: '더불어민주당', score: 94.2, original_score: 88.5, score_changed: true, weight_applied: true },
                            { rank: 2, name: '이건태', party: '더불어민주당', score: 91.8, original_score: 85.3, score_changed: true, weight_applied: true },
                            { rank: 3, name: '박성준', party: '더불어민주당', score: 89.5, original_score: 82.7, score_changed: true, weight_applied: true }
                        ],
                        full_list: generateMockMemberData()
                    },
                    
                    // 메타데이터
                    calculationInfo: {
                        member_count: 300,
                        party_count: 8,
                        calculation_method: 'test_weighted',
                        api_sources: ['test_api']
                    }
                };
                
                // localStorage에 저장
                localStorage.setItem('calculated_data_distribution', JSON.stringify(testData));
                addLog(`localStorage에 계산 데이터 저장 완료`, 'success');
                
                // BroadcastChannel로 전송
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('client_weight_updates_v4');
                    channel.postMessage(testData);
                    channel.close();
                    addLog('BroadcastChannel로 데이터 전송 완료', 'success');
                } else {
                    addLog('BroadcastChannel 미지원', 'warning');
                }
                
                // 정리
                setTimeout(() => {
                    localStorage.removeItem('calculated_data_distribution');
                    addLog('localStorage 정리 완료', 'info');
                }, 1000);
                
                addLog(`✨ 동기화 완료! 가중치 ${Object.keys(weights).length}개 적용`, 'success');
                addLog('🎯 다른 탭들을 확인해보세요!', 'success');
                
            } catch (error) {
                addLog(`동기화 실패: ${error.message}`, 'error');
            }
        }
        
        // 실제 의원 이름을 사용한 모의 데이터 생성
        function generateMockMemberData() {
            const realMembers = [
                { name: '어기구', party: '더불어민주당' },
                { name: '이건태', party: '더불어민주당' },
                { name: '박성준', party: '더불어민주당' },
                { name: '강병원', party: '더불어민주당' },
                { name: '김승원', party: '더불어민주당' },
                { name: '나경원', party: '국민의힘' },
                { name: '정점식', party: '국민의힘' },
                { name: '홍준표', party: '국민의힘' },
                { name: '김기현', party: '국민의힘' },
                { name: '권영세', party: '국민의힘' },
                { name: '조국', party: '조국혁신당' },
                { name: '김종민', party: '조국혁신당' },
                { name: '천하람', party: '개혁신당' },
                { name: '허은아', party: '개혁신당' },
                { name: '강은미', party: '진보당' },
                { name: '윤종오', party: '진보당' },
                { name: '용혜인', party: '기본소득당' },
                { name: '장경태', party: '더불어민주당' },
                { name: '정청래', party: '더불어민주당' },
                { name: '박지원', party: '더불어민주당' },
                { name: '이낙연', party: '더불어민주당' },
                { name: '송영길', party: '더불어민주당' },
                { name: '주호영', party: '국민의힘' },
                { name: '윤한홍', party: '국민의힘' },
                { name: '정진석', party: '국민의힘' },
                { name: '이언주', party: '개혁신당' },
                { name: '김웅', party: '개혁신당' },
                { name: '배현진', party: '국민의힘' },
                { name: '김태년', party: '더불어민주당' },
                { name: '박홍근', party: '더불어민주당' }
            ];
            
            const members = [];
            
            for (let i = 0; i < Math.min(30, realMembers.length); i++) {
                const member = realMembers[i];
                members.push({
                    rank: i + 1,
                    name: member.name,
                    party: member.party,
                    calculated_score: Math.round((95 - i * 0.8) * 10) / 10,
                    original_score: Math.round((88 - i * 0.6) * 10) / 10,
                    score_changed: true,
                    weight_applied: true,
                    calculation_timestamp: new Date().toISOString()
                });
            }
            
            return members;
        }
        
        // 연결 상태 확인
        function checkConnectionStatus() {
            addLog('연결 상태 확인 중...', 'info');
            
            if (typeof BroadcastChannel !== 'undefined') {
                const channel = new BroadcastChannel('client_weight_updates_v4');
                
                const checkMessage = {
                    type: 'connection_check',
                    source: 'sync_tester',
                    timestamp: new Date().toISOString()
                };
                
                let responseCount = 0;
                
                channel.addEventListener('message', function(event) {
                    if (event.data.type === 'connection_response') {
                        responseCount++;
                        addLog(`연결된 페이지 발견: ${event.data.source} (${event.data.data_mode || 'unknown'} 모드)`, 'success');
                    }
                });
                
                channel.postMessage(checkMessage);
                
                setTimeout(() => {
                    addLog(`연결 확인 완료: ${responseCount}개 페이지 응답`, responseCount > 0 ? 'success' : 'warning');
                    if (responseCount === 0) {
                        addLog('다른 페이지들이 열려있는지 확인해주세요', 'warning');
                    }
                    channel.close();
                }, 2000);
                
            } else {
                addLog('BroadcastChannel을 지원하지 않는 브라우저입니다', 'error');
            }
        }
        
        // 브로드캐스트 테스트
        function testBroadcast() {
            addLog('브로드캐스트 테스트 시작...', 'info');
            
            if (typeof BroadcastChannel !== 'undefined') {
                try {
                    const channel = new BroadcastChannel('client_weight_updates_v4');
                    const testMessage = {
                        type: 'test_broadcast',
                        source: 'sync_tester',
                        timestamp: new Date().toISOString(),
                        message: '테스트 메시지입니다!'
                    };
                    
                    channel.postMessage(testMessage);
                    channel.close();
                    
                    addLog('브로드캐스트 테스트 메시지 전송 완료', 'success');
                } catch (error) {
                    addLog(`브로드캐스트 테스트 실패: ${error.message}`, 'error');
                }
            } else {
                addLog('BroadcastChannel을 지원하지 않습니다', 'error');
            }
        }
        
        // 원본 데이터로 리셋
        function resetToOriginal() {
            addLog('원본 데이터로 리셋 요청...', 'info');
            
            const resetData = {
                type: 'data_reset_to_original',
                source: 'sync_tester',
                timestamp: new Date().toISOString(),
                action: 'reset_to_original'
            };
            
            try {
                // localStorage 이벤트
                localStorage.setItem('calculated_data_distribution', JSON.stringify(resetData));
                
                // BroadcastChannel
                if (typeof BroadcastChannel !== 'undefined') {
                    const channel = new BroadcastChannel('client_weight_updates_v4');
                    channel.postMessage(resetData);
                    channel.close();
                }
                
                setTimeout(() => {
                    localStorage.removeItem('calculated_data_distribution');
                }, 500);
                
                addLog('원본 데이터 리셋 요청 전송 완료', 'success');
                addLog('🔄 다른 탭들이 원본 데이터로 복원됩니다', 'success');
                
            } catch (error) {
                addLog(`리셋 요청 실패: ${error.message}`, 'error');
            }
        }
        
        // 초기 총합 계산
        updateTotal();
        
        // 페이지 로드 완료 메시지
        addLog('🎯 가중치 동기화 테스트 도구 준비 완료!', 'success');
        addLog('💡 가중치를 조정하고 "가중치 적용 및 동기화" 버튼을 눌러보세요', 'info');
    </script>
</body>
</html>